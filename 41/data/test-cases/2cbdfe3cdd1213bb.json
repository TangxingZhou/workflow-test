{"uid":"2cbdfe3cdd1213bb","name":"Upgrade Cluster","fullName":"src.tests.upgrade.test_mo_upgrade.UpgradeMOTestSuite#test_upgrade_restored_cluster","historyId":"931059c3ff76815f45987d0d27bb36bc","time":{"start":1710247037317,"stop":1710247038155,"duration":838},"description":"This test attempts to upgrade cluster restored.","descriptionHtml":"<p>This test attempts to upgrade cluster restored.</p>\n","status":"failed","statusMessage":"AssertionError: Failed to patch restored cluster 'restore-freetier-02'.\nassert 415 == 201","statusTrace":"self = <src.tests.upgrade.test_mo_upgrade.UpgradeMOTestSuite object at 0x7f422d4f5c10>\nconfigs = {'cluster': {'image': {'repository': 'registry.cn-shanghai.aliyuncs.com/matrixorigin/matrixone'}, 'name': 'restore-fre...er': {'name': 'restore-freetier-02', 'version': 'nightly-e94ba155'}, 'dir': 's3', ...}}, 'timestamp': '20240312110638'}\nupgrade_version_is_valid = True\n\n    @pytest.mark.p0\n    @pytest.mark.dependency(depends=[\"UpgradeMOTestSuite::test_restore_cluster\"])\n    @allure.title(\"Upgrade Cluster\")\n    @allure.description(\"This test attempts to upgrade cluster restored.\")\n    @allure.tag(\"MO\", \"Upgrade\")\n    @allure.severity(allure.severity_level.CRITICAL)\n    @allure.label(\"owner\", \"TangxingZhou\")\n    # @allure.link(\"https://github.com/matrixorigin/MO-Cloud/issues\", name=\"GitHub\")\n    @allure.issue(\"https://github.com/matrixorigin/MO-Cloud/issues/2542\", name='issue-2542')\n    # @allure.testcase(\"https://github.com/matrixorigin/MO-Cloud/issues/2542\", name='TC-2542')\n    def test_upgrade_restored_cluster(self, configs, upgrade_version_is_valid):\n        if upgrade_version_is_valid:\n            if root_cluster_is_active:\n                body = {\n                    'spec': {\n                        'version': configs['cluster']['version']['to'],\n                        'endpoint': {\n                            'proxySpec': {\n                                'image': f\"{configs['cluster']['image']['repository']}:{configs['cluster']['version']['to']}\"\n                            }\n                        }\n                    }\n                }\n                with allure.step(\"升级集群内核版本\"):\n                    restore_cluster = self.k8s_controller_client.core_matrixone_cloud_v1alpha1_api.patch_cluster(\n                        configs['cluster']['name'], body)\n>                   assert restore_cluster[1] == 201, f\"Failed to patch restored cluster '{configs['cluster']['name']}'.\"\nE                   AssertionError: Failed to patch restored cluster 'restore-freetier-02'.\nE                   assert 415 == 201\n\nsrc/tests/upgrade/test_mo_upgrade.py:644: AssertionError","flaky":false,"newFailed":true,"newBroken":false,"newPassed":false,"retriesCount":0,"retriesStatusChange":false,"beforeStages":[{"name":"k8s_controller_client","time":{"start":1710241598332,"stop":1710241598341,"duration":9},"status":"passed","steps":[],"attachments":[],"parameters":[],"shouldDisplayMessage":false,"stepsCount":0,"attachmentsCount":0,"hasContent":false},{"name":"k8s_unit_client","time":{"start":1710241598341,"stop":1710241598350,"duration":9},"status":"passed","steps":[],"attachments":[],"parameters":[],"shouldDisplayMessage":false,"stepsCount":0,"attachmentsCount":0,"hasContent":false},{"name":"envs","time":{"start":1710241598350,"stop":1710241598350,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"shouldDisplayMessage":false,"stepsCount":0,"attachmentsCount":0,"hasContent":false},{"name":"_xunit_setup_module_fixture_src.tests.upgrade.test_mo_upgrade","time":{"start":1710241598350,"stop":1710241598350,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"shouldDisplayMessage":false,"stepsCount":0,"attachmentsCount":0,"hasContent":false},{"name":"configs","time":{"start":1710241598350,"stop":1710241598355,"duration":5},"status":"passed","steps":[],"attachments":[],"parameters":[],"shouldDisplayMessage":false,"stepsCount":0,"attachmentsCount":0,"hasContent":false},{"name":"setup_module","time":{"start":1710241598350,"stop":1710241598350,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"shouldDisplayMessage":false,"stepsCount":0,"attachmentsCount":0,"hasContent":false},{"name":"setup_class","time":{"start":1710241598385,"stop":1710241600104,"duration":1719},"status":"passed","steps":[],"attachments":[],"parameters":[],"shouldDisplayMessage":false,"stepsCount":0,"attachmentsCount":0,"hasContent":false},{"name":"_xunit_setup_class_fixture_UpgradeMOTestSuite","time":{"start":1710241598385,"stop":1710241598385,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"shouldDisplayMessage":false,"stepsCount":0,"attachmentsCount":0,"hasContent":false},{"name":"upgrade_version_is_valid","time":{"start":1710247037317,"stop":1710247037317,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"shouldDisplayMessage":false,"stepsCount":0,"attachmentsCount":0,"hasContent":false}],"testStage":{"description":"This test attempts to upgrade cluster restored.","status":"failed","statusMessage":"AssertionError: Failed to patch restored cluster 'restore-freetier-02'.\nassert 415 == 201","statusTrace":"self = <src.tests.upgrade.test_mo_upgrade.UpgradeMOTestSuite object at 0x7f422d4f5c10>\nconfigs = {'cluster': {'image': {'repository': 'registry.cn-shanghai.aliyuncs.com/matrixorigin/matrixone'}, 'name': 'restore-fre...er': {'name': 'restore-freetier-02', 'version': 'nightly-e94ba155'}, 'dir': 's3', ...}}, 'timestamp': '20240312110638'}\nupgrade_version_is_valid = True\n\n    @pytest.mark.p0\n    @pytest.mark.dependency(depends=[\"UpgradeMOTestSuite::test_restore_cluster\"])\n    @allure.title(\"Upgrade Cluster\")\n    @allure.description(\"This test attempts to upgrade cluster restored.\")\n    @allure.tag(\"MO\", \"Upgrade\")\n    @allure.severity(allure.severity_level.CRITICAL)\n    @allure.label(\"owner\", \"TangxingZhou\")\n    # @allure.link(\"https://github.com/matrixorigin/MO-Cloud/issues\", name=\"GitHub\")\n    @allure.issue(\"https://github.com/matrixorigin/MO-Cloud/issues/2542\", name='issue-2542')\n    # @allure.testcase(\"https://github.com/matrixorigin/MO-Cloud/issues/2542\", name='TC-2542')\n    def test_upgrade_restored_cluster(self, configs, upgrade_version_is_valid):\n        if upgrade_version_is_valid:\n            if root_cluster_is_active:\n                body = {\n                    'spec': {\n                        'version': configs['cluster']['version']['to'],\n                        'endpoint': {\n                            'proxySpec': {\n                                'image': f\"{configs['cluster']['image']['repository']}:{configs['cluster']['version']['to']}\"\n                            }\n                        }\n                    }\n                }\n                with allure.step(\"升级集群内核版本\"):\n                    restore_cluster = self.k8s_controller_client.core_matrixone_cloud_v1alpha1_api.patch_cluster(\n                        configs['cluster']['name'], body)\n>                   assert restore_cluster[1] == 201, f\"Failed to patch restored cluster '{configs['cluster']['name']}'.\"\nE                   AssertionError: Failed to patch restored cluster 'restore-freetier-02'.\nE                   assert 415 == 201\n\nsrc/tests/upgrade/test_mo_upgrade.py:644: AssertionError","steps":[{"name":"升级集群内核版本","time":{"start":1710247037317,"stop":1710247038155,"duration":838},"status":"failed","statusMessage":"AssertionError: Failed to patch restored cluster 'restore-freetier-02'.\nassert 415 == 201\n","statusTrace":"  File \"/home/runner/work/workflow-test/workflow-test/src/tests/upgrade/test_mo_upgrade.py\", line 644, in test_upgrade_restored_cluster\n    assert restore_cluster[1] == 201, f\"Failed to patch restored cluster '{configs['cluster']['name']}'.\"\n","steps":[],"attachments":[],"parameters":[],"shouldDisplayMessage":true,"stepsCount":0,"attachmentsCount":0,"hasContent":true}],"attachments":[{"uid":"5373e65f0d3c6d0","name":"log","source":"5373e65f0d3c6d0.txt","type":"text/plain","size":580}],"parameters":[],"shouldDisplayMessage":true,"stepsCount":1,"attachmentsCount":1,"hasContent":true},"afterStages":[{"name":"_xunit_setup_class_fixture_UpgradeMOTestSuite::0","time":{"start":1710247038275,"stop":1710247038602,"duration":327},"status":"passed","steps":[],"attachments":[],"parameters":[],"shouldDisplayMessage":false,"stepsCount":0,"attachmentsCount":0,"hasContent":false},{"name":"_xunit_setup_module_fixture_src.tests.upgrade.test_mo_upgrade::0","time":{"start":1710247038603,"stop":1710247038603,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"shouldDisplayMessage":false,"stepsCount":0,"attachmentsCount":0,"hasContent":false}],"labels":[{"name":"severity","value":"critical"},{"name":"suite","value":"Restore MO Cluster and Upgrade"},{"name":"owner","value":"TangxingZhou"},{"name":"feature","value":"Backup/Restore and Upgrade MO Cluster"},{"name":"tag","value":"MO"},{"name":"tag","value":"Upgrade"},{"name":"story","value":"Backup/Restore and Upgrade MO Cluster"},{"name":"epic","value":"MOC Test Automation"},{"name":"tag","value":"dependency(depends=['UpgradeMOTestSuite::test_restore_cluster'])"},{"name":"tag","value":"p0"},{"name":"parentSuite","value":"src.tests.upgrade"},{"name":"subSuite","value":"UpgradeMOTestSuite"},{"name":"host","value":"fv-az1435-418"},{"name":"thread","value":"2254-MainThread"},{"name":"framework","value":"pytest"},{"name":"language","value":"cpython3"},{"name":"package","value":"src.tests.upgrade.test_mo_upgrade"},{"name":"resultFormat","value":"allure2"}],"parameters":[],"links":[{"name":"issue-2542","url":"https://github.com/matrixorigin/MO-Cloud/issues/2542","type":"issue"}],"hidden":false,"retry":false,"extra":{"severity":"critical","owner":"TangxingZhou","retries":[],"categories":[{"name":"Product defects","matchedStatuses":[],"flaky":false}],"history":{"statistic":{"failed":1,"broken":1,"skipped":0,"passed":0,"unknown":0,"total":2},"items":[{"uid":"b056fde488bbcd5b","reportUrl":"https://TangxingZhou.github.io/workflow-test/40//#testresult/b056fde488bbcd5b","status":"broken","statusDetails":"KeyError: 'metadata'","time":{"start":1710239625635,"stop":1710239626433,"duration":798}}]},"tags":["dependency(depends=['UpgradeMOTestSuite::test_restore_cluster'])","p0","MO","Upgrade"]},"source":"2cbdfe3cdd1213bb.json","parameterValues":[]}