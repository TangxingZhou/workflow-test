name: Run MO Tests

on:
  workflow_dispatch:
    inputs:
      testName:
        description: What tests to perform
        type: choice
        required: true
        options:
          - all
          - tpch
          - tpcc
          - sysbench
        default: all
      mo-host:
        description: Host for mo instance
        required: true
        type: string
      mo-port:
        description: Port for mo instance
        required: false
        type: number
        default: 6001
      mo-user:
        description: User name of mo instance
        required: true
        type: string
        default: dump
      mo-password:
        description: Password of mo instance
        required: true
        type: string
        default: Admin123
      period:
        description: Period of time to run tests (mins or times)
        required: true
        type: number
        default: 5
jobs:
  run-sysbench-tests:
    runs-on: ubuntu-latest
    environment:
      name: qa
    if: inputs.testName == 'all' || inputs.testName == 'sysbench'
    steps:
      - name: Checkout mo-load
        uses: actions/checkout@v4
        with:
          repository: matrixorigin/mo-load
          ref: main
          path: mo-load
          token: ${{ secrets.GH_PAT }}

      - name: Set Up Java1.8
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 8

      - uses: ConorMacBride/install-package@v1
        with:
          apt: mysql-client

      - name: Run Sysbench Tests
        run: |
          cd $GITHUB_WORKSPACE/mo-load
          echo "$(date '+%Y-%m-%d %T') - Create database 'sbtest' for sysbench tests"
          mysql \
          -h ${{ inputs.mo-host }} \
          -P ${{ inputs.mo-port }} \
          -u ${{ inputs.mo-user }} \
          -p${{ inputs.mo-password }} \
          -e "drop database if exists sbtest; create database if not exists sbtest;"
          echo "$(date '+%Y-%m-%d %T') - Prepare data for sysbench tests"
          ./start.sh \
          -m SYSBENCH \
          -n 10 \
          -s 100000 \
          -h ${{ inputs.mo-host }} \
          -P ${{ inputs.mo-port }} \
          -u ${{ inputs.mo-user }} \
          -p ${{ inputs.mo-password }} \
          -b sbtest
          echo "$(date '+%Y-%m-%d %T') - Start to run sysbench tests"
          ./start.sh \
          -c cases/sysbench/mixed_10_100000/ \
          -t 10 \
          -d ${{ inputs.period }} \
          -h ${{ inputs.mo-host }} \
          -P ${{ inputs.mo-port }} \
          -u ${{ inputs.mo-user }} \
          -p ${{ inputs.mo-password }} \
          -b sbtest \
          -g > sysbench.log 2>&1
          echo "$(date '+%Y-%m-%d %T') - Complete to run sysbench tests"

      - name: Upload Logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: sysbench-test-logs
          path: |
            ${{ github.workspace }}/mo-load/*.log
            ${{ github.workspace }}/mo-load/report/
          retention-days: 7

  run-tpcc-tests:
    runs-on: ubuntu-latest
    environment:
      name: qa
    if: inputs.testName == 'all' || inputs.testName == 'tpcc'
    steps:
      - name: Checkout mo-load-data
        uses: actions/checkout@v4
        with:
          repository: matrixorigin/mo-load-data
          ref: main
          path: mo-load-data
          token: ${{ secrets.GH_PAT }}

      - uses: ConorMacBride/install-package@v1
        with:
          apt: mysql-client

      - name: Load TPCC Data
        run: |
          cd $GITHUB_WORKSPACE/mo-load-data
          sed -i \
          -e 's/\(ENDPOINT:\).*/\1 oss-cn-hangzhou-internal.aliyuncs.com/' \
          -e 's/\(ACCESS_KEY_ID:\).*/\1 ${{ secrets.RESTORE_ALIYUN_AK }}/' \
          -e 's/\(SECRET_ACCESS_KEY:\).*/\1 ${{ secrets.RESTORE_ALIYUN_SK }}/' \
          access.yml
          ./load.sh \
          -c cases/00_from_s3/tpcc_10 -d tpcc_10 -m -r \
          -b moc-test-data \
          -h ${{ inputs.mo-host }} \
          -P ${{ inputs.mo-port }} \
          -u ${{ inputs.mo-user }} \
          -p ${{ inputs.mo-password }} \
          2>&1 | tee load-tpcc-data.log

      - name: Checkout mo-tpcc
        uses: actions/checkout@v3
        with:
          repository: matrixorigin/mo-tpcc
          ref: main
          path: mo-tpcc
          token: ${{ secrets.GH_PAT }}

      - name: Set Up Java1.8
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 8

      - name: Run TPCC Tests
        run: |
          cd $GITHUB_WORKSPACE/mo-tpcc
          cp props.mo props_10.mo
          sed -i 's/socketTimeout=60000/socketTimeout=60000/' props_10.mo
          sed -i '/.*terminals=*/c\terminals=10' props_10.mo
          sed -i '/.*warehouses=*/c\warehouses=10' props_10.mo
          sed -i '/.*user=*/c\user=${{ inputs.mo-user }}' props_10.mo
          sed -i "/.*password=*/c\password=${{ inputs.mo-password }}" props_10.mo
          sed -i '/runMins=*/c\runMins=${{ inputs.period }}' props_10.mo
          sed -i 's/tpcc/tpcc_10/g' props_10.mo
          sed -i 's/127.0.0.1/${{ inputs.mo-host }}/g' props_10.mo
          ./runBenchmark.sh props_10.mo
          ./runVerify.sh props_10.mo

      - name: Upload Logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: load-tpcc-data-logs
          path: |
            ${{ github.workspace }}/mo-load-data/*.log
            ${{ github.workspace }}/mo-load-data/report/
            ${{ github.workspace }}/mo-tpcc/*.log
            ${{ github.workspace }}/mo-tpcc/report/
          retention-days: 7

  run-tpch-tests:
    runs-on: ubuntu-latest
    environment:
      name: qa
    if: inputs.testName == 'all' || inputs.testName == 'tpch'
    steps:
      - name: Checkout mo-tpch
        uses: actions/checkout@v4
        with:
          repository: matrixorigin/mo-tpch
          ref: main
          path: mo-tpch
          token: ${{ secrets.GH_PAT }}

      - uses: ConorMacBride/install-package@v1
        with:
          apt: mysql-client

      - name: Run TPCH Tests
        run: |
          cd $GITHUB_WORKSPACE/mo-tpch
          echo "$(date '+%Y-%m-%d %T') - Create database 'tpch_10g' for tpch tests"
          mysql \
          -h ${{ inputs.mo-host }} \
          -P ${{ inputs.mo-port }} \
          -u ${{ inputs.mo-user }} \
          -p${{ inputs.mo-password }} \
          -e "drop database if exists tpch_10g; create database tpch_10g from sys publication mo_sample_data_tpch_sf10;"
          echo "$(date '+%Y-%m-%d %T') - Start to run TPCH_10G tests"
          ./run.sh \
          -q all \
          -s 10 \
          -t ${{ inputs.period }} \
          -d tpch_10g \
          -h ${{ inputs.mo-host }} \
          -P ${{ inputs.mo-port }} \
          -u ${{ inputs.mo-user }} \
          -p ${{ inputs.mo-password }} \
          2>&1 | tee tpch.log

      - name: Upload Logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: tpch-test-logs
          path: |
            ${{ github.workspace }}/mo-tpch/*.log
            ${{ github.workspace }}/mo-tpch/report/
          retention-days: 7